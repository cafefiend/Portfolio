<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            background-color: #1e2848;
        }

        h1 {
            color: #ffffff;
        }

        p {
            color: #ffffff;
            font-size: 0.86em;
        }

        h2 {
            color: rgb(101, 135, 228);
        }

        .menu {
            float: left;
            width: 20%;
        }

        .main {
            float: left;
            width: 80%;
            padding: 0 20px;
            overflow: scroll;
        }

        .footer {
            text-align: left;
            margin: 20px;
            padding: 5px;
            width: 100vw;
            background-color: rgb(146, 144, 144);
            color: rgb(0, 0, 0);
        }

        .chartBox {
            width: 800px;
            min-height: fit-content;
            padding: 20px;
            border-radius: 10px;
            border: solid 3px rgba(54, 162, 235, 1);
            background: white;
        }

        #tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 5px;
            border-radius: 5px;
            opacity: 0;
            pointer-events: none;
        }

    </style>
</head>
<body style="font-family:Verdana;">
    <div style="background-color:#8ba7fb;padding:15px;">
        <h1>Cafe Fiend's Corner</h1>
    </div>
    <div class="main">
      <h2>Real-time PSI Updates</h2>
      <p>Click on the image to see live updates of PSI in Singapore</p>
      <a href="live-psi.html">
          <img src="Assets/Images/img_psi.png" alt="PSI" style="width: 500px;">
      </a>

      <h2>Simple Query Data Using API</h2>
      <p>How does the price of 4-Room flats in Ang Mo Kio compare between 2017 to 2022?</p>
      <p>Aim: To explore how the prices of 4-Room HDB flats have changed over the last 6 years based on the median price.</p>

      <div class="chartBox">
          <canvas id="myChart"></canvas>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.3/d3.min.js" integrity="sha512-Bg2eiKHzTFFm3RXa2xWihCacicF47EiEtkk/qD2UpqimWHNnQsIJxuwrf958rNHVvkpcjRgUyPblU6LOoAxTSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
              const chartData = 'Assets/Charts/HDB-4Rm/Data/new_resaleAMK_median.csv';

              //parse the file from CSV to JSON
              d3.csv(chartData).then(function(datapoints){
                  console.log(datapoints)
                  const resalePrice = [];
                  const Year = [];

                  for (i = 0; i < datapoints.length; i++) {
                      resalePrice.push(datapoints[i].resale_price)
                      Year.push(datapoints[i].Year)
                  }

                  // setup
                  const data = {
                      labels: Year,
                      datasets: [{
                          label: 'Median Resale Price $',
                          data: resalePrice,
                          backgroundColor: [
                              'rgba(0, 31, 125, 0.5)',
                              'rgba(0, 31, 125, 0.5)',
                              'rgba(255, 206, 86, 0.5)',
                              'rgba(75, 192, 192, 0.5)',
                              'rgba(0, 31, 125, 0.5)',
                              'rgba(0, 31, 125, 0.5)',
                              'rgba(0, 31, 125, 0.5)'
                          ],
                          borderColor: [
                              'rgba(0, 31, 125, 0.8)',
                              'rgba(0, 31, 125, 0.8)',
                              'rgba(255, 206, 86, 1)',
                              'rgba(75, 192, 192, 1)',
                              'rgba(0, 31, 125, 0.8)',
                              'rgba(0, 31, 125, 0.8)',
                              'rgba(0, 31, 125, 0.8)'
                          ],
                          borderWidth: 1
                      }]
                  };

                  // config
                  const config = {
                      type: 'bar',
                      data,
                      options: {
                          scales: {
                              y: {
                                  beginAtZero: true
                              }
                          }
                      }
                  };

                  // render init block
                  const myChart = new Chart(
                      document.getElementById('myChart'),
                      config
                  );

              });
          </script>
      </div>
      
    <div class="main">
        <h2>Simple Choropleth Map of Singapore's Population</h2>

        <div id="map-container" style="width: 100%; height: 500px;">
            <svg></svg> <!-- Add this SVG container for D3 to draw on -->
        </div>
        <div id="tooltip"></div> <!-- Add this div for the tooltip -->

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.3/d3.min.js" integrity="sha512-Bg2eiKHzTFFm3RXa2xWihCacicF47EiEtkk/qD2UpqimWHNnQsIJxuwrf958rNHVvkpcjRgUyPblU6LOoAxTSA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

        <script>
            const [WIDTH, HEIGHT] = [1200, 700]
            const state = {}

            function setupSvg() {
                state['svg'] = d3.select("svg")
                    .attr("viewBox", "0 0 " + WIDTH + " " + HEIGHT)
                    .attr('width', WIDTH)
                    .attr('height', HEIGHT)

                state['legend'] = state['svg'].append('g').classed('legend-container', true)
            }

            async function loadData() {
                const [mapData, popData] = await 
                Promise.all([d3.json("Assets/Choropleth/sgmap.json"), 
                d3.csv("Assets/Choropleth/population2022.csv")])
                state['mapData'] = mapData
                state['subzoneToPopMap'] = {}
                for (const { Subzone, Population } of popData) {
                    state['subzoneToPopMap'][Subzone.toLowerCase()] = +Population
                }

                console.log('mapData', mapData);
                console.log('popData', popData);
                console.log('subzoneToPopMap', state['subzoneToPopMap']);
            }

            function featureToPop(feature) {
                return state['subzoneToPopMap'][feature.properties['Subzone Name'].toLowerCase()] || -1
            }

            async function main() {
                setupSvg()
                await loadData()

                // Map and projection
                var projection = d3.geoMercator()
                    .center([103.851959, 1.290270])
                    .fitExtent([[20, 20], [980, 580]], state['mapData']);

                let geopath = d3.geoPath().projection(projection);

                // Draw the map
                const vals = Object.values(state.subzoneToPopMap)
                const scale = d3.scaleSequential(d3.interpolateWarm).domain([d3.min(vals), d3.max(vals)])
                const tooltip = d3.select('#tooltip')

                state['svg'].append("g")
                    .attr("id", "districts")
                    .selectAll("path")
                    .data(state['mapData'].features)
                    .enter()
                    .append("path")
                    .attr("d", geopath)
                    .attr("fill", f => {
                        const val = featureToPop(f)
                        if (val == -1) return 'black'
                        return scale(val)
                    })
                    .on("mouseover", function(e, f) {		
                        const pop = featureToPop(f)
                        tooltip
                            .style('opacity', 1)
                            .style("left", (e.pageX) + "px")		
                            .style("top", (e.pageY - 28) + "px")
                            .text(`Population: ${pop == -1 ? "Unknown" : pop}`)
                    })					
                    .on("mouseout", function() {		
                        tooltip.style('opacity', 0)
                    });

                const points = [-1]
                const NUM_POINTS = 10
                const [domainMin, domainMax] = scale.domain()
                for (let i = 0; i < 10; i++) {
                    const point = domainMin + (domainMax - domainMin) / (NUM_POINTS - 1) * i
                    points.push(point)
                }

                const legendPoint = state['legend'].selectAll('g')
                    .data(points)
                    .join('g')

                const R = 10
                const Y_START = 30
                legendPoint.append('rect')
                    .attr('x', WIDTH - 200)
                    .attr('y', (_, idx) => Y_START + idx * 30)
                    .attr('width', R)
                    .attr('height', R)
                    .attr('fill', p => p == -1 ? 'black' : scale(p))

                legendPoint.append('text')
                    .attr('x', WIDTH - 200 + R*3)
                    .attr('y', (_, idx) => Y_START + idx * 30 + R/2)
                    .text(p => p == -1 ? "Legend" : Math.round(p))
                    .attr('fill', p => p == -1 ? 'lightgrey' : scale(p))
            }

            main()
        </script>
    </div>
</body>
</html>
